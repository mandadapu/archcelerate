# Pre-Deployment Checklist

Complete this checklist before deploying to Google Cloud Run.

## Deployment Architecture Choice

Choose ONE of the following architectures:

### Option A: Google Cloud Native Services (Recommended for Production)
**Cost**: ~$20-25/month | **Latency**: <1ms database/cache access

- Cloud SQL for PostgreSQL (managed)
- Redis on Compute Engine (self-hosted VM)
- VPC connector for private networking
- All provisioned via `./scripts/provision-gcp-services.sh`

### Option B: External Managed Services (Recommended for Dev/Test)
**Cost**: ~$0/month (free tiers) | **Latency**: 10-50ms database/cache access

- Supabase (PostgreSQL with pgvector)
- Upstash (managed Redis)
- Public endpoints (no VPC needed)
- Manual setup required

---

## Option A: Google Cloud Native Services Setup

Skip this section if using Option B.

### Automated Provisioning (Recommended)

- [ ] GCP environment variables set
  ```bash
  export GCP_PROJECT_ID="your-project-id"
  export GCP_REGION="us-central1"
  export GCP_ZONE="us-central1-a"
  ```
- [ ] Run provisioning script
  ```bash
  ./scripts/provision-gcp-services.sh
  ```
  This automatically creates:
  - Cloud SQL PostgreSQL (db-f1-micro)
  - pgvector extension enabled
  - Redis on Compute Engine (e2-micro)
  - VPC connector
  - DATABASE_URL and REDIS_URL secrets

**Provisioning takes ~10-12 minutes. Skip to [API Keys & Credentials](#api-keys--credentials) section after running this script.**

---

## Option B: External Managed Services Setup

Skip this section if using Option A.

### Supabase (PostgreSQL)

- [ ] Supabase account created at https://supabase.com
- [ ] Project created
- [ ] pgvector extension enabled
  ```sql
  -- Run in Supabase SQL Editor
  CREATE EXTENSION IF NOT EXISTS vector;
  ```
- [ ] Connection string copied (Settings → Database → Connection string → URI)
- [ ] Use "Connection Pooling" mode for Cloud Run compatibility

### Upstash (Redis)

- [ ] Upstash account created at https://upstash.com
- [ ] Redis database created
- [ ] Region selected (choose closest to your Cloud Run region)
- [ ] TLS enabled (use `rediss://` URL)
- [ ] Connection string copied from database details

## GCP Setup

- [ ] GCP account created with billing enabled
- [ ] `gcloud` CLI installed
  ```bash
  gcloud --version
  ```
- [ ] Authenticated with GCP
  ```bash
  gcloud auth login
  gcloud auth application-default login
  ```
- [ ] Project created or selected
  ```bash
  gcloud projects create PROJECT_ID  # or
  gcloud config set project PROJECT_ID
  ```
- [ ] Billing enabled for project

## API Keys & Credentials

### Anthropic (Claude API)

- [ ] Account created at https://console.anthropic.com
- [ ] API key generated (Settings → API Keys)
- [ ] Credits/billing configured

### OpenAI (GPT API)

- [ ] Account created at https://platform.openai.com
- [ ] API key generated (API Keys section)
- [ ] Billing set up

### Google OAuth

- [ ] Google Cloud project OAuth consent screen configured
- [ ] OAuth 2.0 Client ID created (Type: Web application)
- [ ] Authorized JavaScript origins: `https://your-domain.run.app`
- [ ] Authorized redirect URIs: `https://your-domain.run.app/api/auth/callback/google`
- [ ] Client ID and Client Secret copied

### Facebook OAuth (Optional)

- [ ] Facebook Developer account created
- [ ] App created in Facebook Developer Console
- [ ] Valid OAuth Redirect URIs configured: `https://your-domain.run.app/api/auth/callback/facebook`
- [ ] App ID and App Secret copied

### Tavily API (Optional)

- [ ] Account created at https://tavily.com
- [ ] API key generated

## NextAuth Configuration

- [ ] NEXTAUTH_SECRET generated (min 32 characters)
  ```bash
  openssl rand -base64 32
  ```

## Environment Variables Collected

Create a secure note or password manager entry with:

**For Option A (Google Cloud Native):**
```
# DATABASE_URL and REDIS_URL are auto-generated by provision-gcp-services.sh
ANTHROPIC_API_KEY=sk-ant-...
OPENAI_API_KEY=sk-...
NEXTAUTH_SECRET=... (generate with: openssl rand -base64 32)
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...
FACEBOOK_CLIENT_ID=... (optional)
FACEBOOK_CLIENT_SECRET=... (optional)
TAVILY_API_KEY=... (optional)
```

**For Option B (External Services):**
```
DATABASE_URL=postgresql://... (from Supabase)
REDIS_URL=rediss://... (from Upstash)
ANTHROPIC_API_KEY=sk-ant-...
OPENAI_API_KEY=sk-...
NEXTAUTH_SECRET=... (generate with: openssl rand -base64 32)
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...
FACEBOOK_CLIENT_ID=... (optional)
FACEBOOK_CLIENT_SECRET=... (optional)
TAVILY_API_KEY=... (optional)
```

## Pre-Deployment Tests

- [ ] Application runs locally
  ```bash
  npm install
  npm run build
  npm start
  ```
- [ ] Database migrations run successfully
  ```bash
  npx prisma migrate deploy
  ```
- [ ] Tests pass
  ```bash
  npm run test:unit
  ```
- [ ] Docker build succeeds
  ```bash
  docker build -t archcelerate-test .
  ```

## Deployment Scripts Ready

- [ ] `scripts/provision-gcp-services.sh` is executable (Option A only)
- [ ] `scripts/setup-secrets.sh` is executable
- [ ] `scripts/deploy-gcp.sh` is executable
- [ ] `scripts/run-migrations.sh` is executable
- [ ] GCP environment variables set
  ```bash
  export GCP_PROJECT_ID="your-project-id"
  export GCP_REGION="us-central1"  # optional
  export GCP_ZONE="us-central1-a"  # optional (for Option A)
  ```

## Ready to Deploy

Once all items are checked:

### Option A: Google Cloud Native Services

```bash
# 1. Provision Cloud SQL and Redis (~10-12 minutes)
./scripts/provision-gcp-services.sh

# 2. Setup API keys and secrets
./scripts/setup-secrets.sh

# 3. Deploy to Cloud Run
./scripts/deploy-gcp.sh

# 4. Run database migrations
./scripts/run-migrations.sh

# 5. Verify deployment
curl https://your-service.run.app/api/health
```

### Option B: External Managed Services

```bash
# 1. Setup all secrets (including DATABASE_URL and REDIS_URL)
./scripts/setup-secrets.sh

# 2. Deploy to Cloud Run
./scripts/deploy-gcp.sh

# 3. Run database migrations
./scripts/run-migrations.sh

# 4. Verify deployment
curl https://your-service.run.app/api/health
```

## Post-Deployment

- [ ] Service URL obtained and documented
- [ ] NEXTAUTH_URL updated (if needed)
- [ ] OAuth redirect URIs updated in Google/Facebook consoles
- [ ] Health check passes
- [ ] Login flow tested
- [ ] AI features tested
- [ ] Monitoring/alerts configured (optional)
