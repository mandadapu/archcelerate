# Dynamic Quiz Questions with AI Generation

The Skill Diagnosis quiz now uses **AI-generated questions** with Redis caching for optimal performance.

## How It Works

1. **First Request**: Questions are generated by Claude AI
2. **Caching**: Generated questions are cached in Redis for 7 days
3. **Subsequent Requests**: Questions are served instantly from cache
4. **Fallback**: If generation fails, static fallback questions are used

## Architecture

```
User Request
    â†“
GET /api/diagnosis/questions
    â†“
Check Redis Cache
    â”œâ”€ Cache Hit â†’ Return cached questions (âš¡ instant)
    â””â”€ Cache Miss â†’ Generate with Claude (ðŸ¤– ~10s)
         â†“
    Save to Redis (TTL: 7 days)
         â†“
    Return fresh questions
```

## API Endpoints

### GET /api/diagnosis/questions

Fetch quiz questions (from cache or generate new).

**Query Parameters:**
- `refresh=true` - Force regeneration, bypass cache

**Response:**
```json
{
  "questions": [...],
  "source": "cache" | "generated" | "fallback"
}
```

**Example:**
```bash
# Get questions (use cache if available)
curl http://localhost:3000/api/diagnosis/questions

# Force refresh
curl http://localhost:3000/api/diagnosis/questions?refresh=true
```

### POST /api/diagnosis/questions

Admin endpoint to manually refresh questions.

**Request:**
```json
{
  "adminKey": "your-secret-admin-key"
}
```

**Response:**
```json
{
  "success": true,
  "questionsCount": 15,
  "message": "Questions refreshed successfully"
}
```

**Example:**
```bash
curl -X POST http://localhost:3000/api/diagnosis/questions \
  -H "Content-Type: application/json" \
  -d '{"adminKey":"your-secret-key"}'
```

## Configuration

### Environment Variables

Add to your `.env.local`:

```bash
# Required for question generation
ANTHROPIC_API_KEY=sk-ant-your-key

# Required for admin refresh endpoint
ADMIN_REFRESH_KEY=your-secret-admin-key

# Redis connection (defaults to localhost:6379)
REDIS_URL=redis://localhost:6379
```

### Cache Settings

Edit in `/app/api/diagnosis/questions/route.ts`:

```typescript
const CACHE_TTL = 60 * 60 * 24 * 7 // 7 days (in seconds)
```

## Question Generation Prompt

Questions are generated with this structure:
- **15 total questions**
- LLM Fundamentals (5)
- Prompt Engineering (3)
- RAG Systems (3)
- AI Agents (2)
- Production Deployment (2)

Each question includes:
- Clear technical question
- 4 multiple-choice options
- Correct answer(s)
- Skill area classification
- Difficulty level

## UI Indicators

The diagnosis page shows the question source:

- ðŸ¤– **AI Generated** - Freshly generated by Claude
- âš¡ **Cached** - Served from Redis cache
- ðŸ“‹ **Fallback** - Static questions (if generation failed)

## Manual Refresh

### Option 1: Query Parameter
```bash
curl "http://localhost:3000/api/diagnosis/questions?refresh=true"
```

### Option 2: Admin API
```bash
curl -X POST http://localhost:3000/api/diagnosis/questions \
  -H "Content-Type: application/json" \
  -d '{"adminKey":"'$ADMIN_REFRESH_KEY'"}'
```

### Option 3: Redis CLI
```bash
# Connect to Redis
docker exec -it archcelerate-redis redis-cli

# Delete cache key
DEL diagnosis:quiz:questions

# Verify deletion
EXISTS diagnosis:quiz:questions  # Should return 0
```

## Monitoring

### Check Cache Status
```bash
# Connect to Redis
docker exec -it archcelerate-redis redis-cli

# Check if questions are cached
EXISTS diagnosis:quiz:questions

# Get TTL (time to live)
TTL diagnosis:quiz:questions

# View cached questions
GET diagnosis:quiz:questions | jq
```

### View Logs
```bash
# Watch question generation logs
docker-compose logs -f app | grep -i "quiz\|questions"
```

## Production Recommendations

1. **Warm the cache** on deployment:
   ```bash
   curl -X POST https://yourapp.com/api/diagnosis/questions \
     -H "Content-Type: application/json" \
     -d '{"adminKey":"'$ADMIN_REFRESH_KEY'"}'
   ```

2. **Set up scheduled refresh** (every 7 days):
   ```yaml
   # GitHub Actions example
   - name: Refresh Quiz Questions
     run: |
       curl -X POST ${{ secrets.APP_URL }}/api/diagnosis/questions \
         -H "Content-Type: application/json" \
         -d '{"adminKey":"${{ secrets.ADMIN_REFRESH_KEY }}"}'
     schedule:
       - cron: '0 0 * * 0'  # Weekly on Sunday
   ```

3. **Monitor cache hit rate** in Redis:
   ```bash
   redis-cli INFO stats | grep keyspace
   ```

## Troubleshooting

### Questions not updating?
```bash
# Force refresh
curl "http://localhost:3000/api/diagnosis/questions?refresh=true"
```

### Generation failing?
- Check `ANTHROPIC_API_KEY` is set correctly
- Check Redis is running: `docker-compose ps redis`
- View error logs: `docker-compose logs app | grep ERROR`

### Always using fallback?
- Check Anthropic API key balance/quota
- Check network connectivity to Anthropic API
- Verify Redis connection: `docker-compose exec app redis-cli ping`

## Benefits

âœ… **Dynamic Content**: Questions can evolve without code changes
âœ… **Performance**: Redis caching = instant loading
âœ… **Reliability**: Automatic fallback to static questions
âœ… **Fresh Content**: Weekly refresh keeps questions updated
âœ… **Cost Effective**: Claude called only once per 7 days
âœ… **Scalability**: Redis handles high concurrency

## Future Enhancements

- [ ] A/B testing different question sets
- [ ] Personalized questions based on user background
- [ ] Difficulty adaptation based on user performance
- [ ] Question analytics dashboard
- [ ] Multi-language support
