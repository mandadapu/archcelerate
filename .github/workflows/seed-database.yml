name: Seed Database

on:
  workflow_dispatch:
    inputs:
      skip_migrations:
        description: 'Skip database migrations'
        required: false
        type: boolean
        default: false
      week:
        description: 'Seed specific week (1-12, or "all" for all weeks)'
        required: false
        type: string
        default: 'all'

env:
  GCP_PROJECT_ID: archcelerate
  GCP_REGION: us-central1

jobs:
  seed:
    name: Seed Production Database
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get Database Credentials
        id: db-creds
        run: |
          DB_PASSWORD=$(gcloud secrets versions access latest --secret=DB_PASSWORD --project=${{ env.GCP_PROJECT_ID }})
          DB_HOST=$(gcloud sql instances describe archcelerate-db --project=${{ env.GCP_PROJECT_ID }} --format="value(ipAddresses[0].ipAddress)")
          echo "DATABASE_URL=postgresql://postgres:${DB_PASSWORD}@${DB_HOST}:5432/archcelerate?schema=public" >> $GITHUB_OUTPUT
        shell: bash

      - name: Run Database Migrations
        if: ${{ !inputs.skip_migrations }}
        id: migrate
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ steps.db-creds.outputs.DATABASE_URL }}

      - name: Seed Database
        id: seed
        run: |
          echo "ğŸŒ± Seeding database..."

          case "${{ inputs.week }}" in
            "all")
              echo "Seeding all 12 weeks using master seed file..."
              npm run db:seed
              ;;
            "1")
              echo "Seeding Week 1 only..."
              npm run db:seed:week1
              ;;
            "2")
              echo "Seeding Week 2 only..."
              npm run db:seed:week2
              ;;
            "5")
              echo "Seeding Week 5 only..."
              npm run db:seed:week5
              ;;
            "6")
              echo "Seeding Week 6 only..."
              npm run db:seed:week6
              ;;
            *)
              echo "Invalid week specified. Please use 'all' or a week number 1-12."
              echo "Note: Individual seed scripts exist only for weeks 1, 2, 5, 6."
              echo "For other weeks, use 'all' to seed everything."
              exit 1
              ;;
          esac

          echo "âœ… Database seeding completed"
        env:
          DATABASE_URL: ${{ steps.db-creds.outputs.DATABASE_URL }}

      - name: Verify Seeding
        id: verify
        run: |
          echo "ğŸ“Š Verifying seeded data..."

          # Create a temporary SQL query file
          cat > /tmp/verify.sql << 'EOF'
          SELECT
            'Weeks' as type,
            COUNT(*)::text as count
          FROM "CurriculumWeek"
          UNION ALL
          SELECT
            'Concepts' as type,
            COUNT(*)::text as count
          FROM "Concept"
          UNION ALL
          SELECT
            'Labs' as type,
            COUNT(*)::text as count
          FROM "Lab"
          UNION ALL
          SELECT
            'Projects' as type,
            COUNT(*)::text as count
          FROM "WeekProject";
          EOF

          # Run the query using psql via Cloud SQL proxy
          npx prisma db execute --file /tmp/verify.sql --schema prisma/schema.prisma || echo "âš ï¸  Verification query failed"

          # Alternative: Use Prisma Client to query
          cat > /tmp/verify.ts << 'EOF'
          import { PrismaClient } from '@prisma/client'
          const prisma = new PrismaClient()
          async function main() {
            const weeks = await prisma.curriculumWeek.count()
            const concepts = await prisma.concept.count()
            const labs = await prisma.lab.count()
            const projects = await prisma.weekProject.count()
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
            console.log('ğŸ“Š DATABASE CONTENTS')
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
            console.log(`Weeks:    ${weeks}`)
            console.log(`Concepts: ${concepts}`)
            console.log(`Labs:     ${labs}`)
            console.log(`Projects: ${projects}`)
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
          }
          main().finally(() => prisma.$disconnect())
          EOF

          npx tsx /tmp/verify.ts
        env:
          DATABASE_URL: ${{ steps.db-creds.outputs.DATABASE_URL }}

      - name: Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ± DATABASE SEEDING SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Configuration:"
          echo "  Project:          ${{ env.GCP_PROJECT_ID }}"
          echo "  Skip Migrations:  ${{ inputs.skip_migrations || false }}"
          echo "  Week Filter:      ${{ inputs.week || 'all' }}"
          echo ""
          echo "Status:"
          echo "  Migrations:       ${{ steps.migrate.outcome || 'skipped' }}"
          echo "  Seeding:          ${{ steps.seed.outcome || 'N/A' }}"
          echo "  Verification:     ${{ steps.verify.outcome || 'N/A' }}"
          echo ""
          echo "Expected for 'all' weeks:"
          echo "  - 12 curriculum weeks"
          echo "  - 41 concepts (varies by week: 3-6 per week)"
          echo "  - 12 labs (1 per week)"
          echo "  - 12 projects (1 per week)"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
