name: Seed Database

on:
  workflow_dispatch:
    inputs:
      skip_migrations:
        description: 'Skip database migrations'
        required: false
        type: boolean
        default: false
      week:
        description: 'Seed specific week (1-12, or "all" for all weeks)'
        required: false
        type: string
        default: 'all'

permissions:
  contents: read

jobs:
  seed:
    name: Seed Production Database
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Fetch database credentials from Secret Manager
        id: secrets
        run: |
          DB_URL=$(gcloud secrets versions access latest --secret=DATABASE_URL --project=archcelerate)
          echo "::add-mask::$DB_URL"
          # Rewrite Cloud SQL socket path to use localhost via proxy
          # Original: postgresql://user:pass@localhost/db?host=/cloudsql/instance
          # Rewritten: postgresql://user:pass@127.0.0.1:5432/db
          PROXY_URL=$(echo "$DB_URL" | sed 's|?host=/cloudsql/[^&]*||' | sed 's|@localhost/|@127.0.0.1:5432/|')
          echo "::add-mask::$PROXY_URL"
          echo "DATABASE_URL=$PROXY_URL" >> $GITHUB_ENV

      - name: Start Cloud SQL Auth Proxy
        run: |
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.14.3/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy
          ./cloud-sql-proxy archcelerate:us-central1:archcelerate-db --port 5432 &
          sleep 3
          echo "Cloud SQL Proxy started"

      - name: Run Database Migrations
        if: ${{ !inputs.skip_migrations }}
        id: migrate
        run: npx prisma migrate deploy

      - name: Seed Database
        id: seed
        run: |
          echo "Seeding database..."

          case "${{ inputs.week }}" in
            "all")
              echo "Seeding all 12 weeks using master seed file..."
              npm run db:seed
              ;;
            "1")
              echo "Seeding Week 1 only..."
              npm run db:seed:week1
              ;;
            "2")
              echo "Seeding Week 2 only..."
              npm run db:seed:week2
              ;;
            "5")
              echo "Seeding Week 5 only..."
              npm run db:seed:week5
              ;;
            "6")
              echo "Seeding Week 6 only..."
              npm run db:seed:week6
              ;;
            *)
              echo "Invalid week specified. Please use 'all' or a week number 1-12."
              echo "Note: Individual seed scripts exist only for weeks 1, 2, 5, 6."
              echo "For other weeks, use 'all' to seed everything."
              exit 1
              ;;
          esac

          echo "Database seeding completed"

      - name: Verify Seeding
        id: verify
        run: |
          echo "Verifying seeded data..."

          cat > /tmp/verify.ts << 'EOF'
          import { PrismaClient } from '@prisma/client'
          const prisma = new PrismaClient()
          async function main() {
            const weeks = await prisma.curriculumWeek.count()
            const concepts = await prisma.concept.count()
            const labs = await prisma.lab.count()
            const projects = await prisma.weekProject.count()
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
            console.log('DATABASE CONTENTS')
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
            console.log(`Weeks:    ${weeks}`)
            console.log(`Concepts: ${concepts}`)
            console.log(`Labs:     ${labs}`)
            console.log(`Projects: ${projects}`)
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
          }
          main().finally(() => prisma.$disconnect())
          EOF

          npx tsx /tmp/verify.ts

      - name: Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ± DATABASE SEEDING SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Configuration:"
          echo "  Project:          archcelerate"
          echo "  Skip Migrations:  ${{ inputs.skip_migrations || false }}"
          echo "  Week Filter:      ${{ inputs.week || 'all' }}"
          echo ""
          echo "Status:"
          echo "  Migrations:       ${{ steps.migrate.outcome || 'skipped' }}"
          echo "  Seeding:          ${{ steps.seed.outcome || 'N/A' }}"
          echo "  Verification:     ${{ steps.verify.outcome || 'N/A' }}"
          echo ""
          echo "Expected for 'all' weeks:"
          echo "  - 12 curriculum weeks"
          echo "  - 41 concepts (varies by week: 3-6 per week)"
          echo "  - 12 labs (1 per week)"
          echo "  - 12 projects (1 per week)"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
