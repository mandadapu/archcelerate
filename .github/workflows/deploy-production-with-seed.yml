name: Deploy to Production with Database Seeding

on:
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip Docker build (use existing image)'
        required: false
        type: boolean
        default: false
      skip_migrations:
        description: 'Skip database migrations'
        required: false
        type: boolean
        default: false
      skip_seeding:
        description: 'Skip database seeding'
        required: false
        type: boolean
        default: false
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - 'prisma/**'
      - 'scripts/**'
      - 'package.json'
      - 'Dockerfile'

env:
  GCP_PROJECT_ID: archcelerate
  GCP_REGION: us-central1
  GCP_SERVICE_NAME: archcelerate
  GCP_ARTIFACT_REPO: archcelerate-repo
  NODE_VERSION: '20'

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        id: checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        id: setup-node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        id: install
        run: npm ci --legacy-peer-deps

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        id: setup-gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        id: docker-config
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build and Push Docker Image
        id: build
        if: ${{ !inputs.skip_build }}
        run: |
          echo "Building Docker image..."
          gcloud builds submit \
            --tag ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GCP_ARTIFACT_REPO }}/${{ env.GCP_SERVICE_NAME }}:latest \
            --timeout=15m

      - name: Deploy to Cloud Run
        id: deploy
        if: ${{ !inputs.skip_build }}
        run: |
          echo "Deploying to Cloud Run..."

          # Build secrets list dynamically
          REQUIRED_SECRETS="ANTHROPIC_API_KEY=ANTHROPIC_API_KEY:latest,NEXTAUTH_SECRET=NEXTAUTH_SECRET:latest,GOOGLE_CLIENT_ID=GOOGLE_CLIENT_ID:latest,GOOGLE_CLIENT_SECRET=GOOGLE_CLIENT_SECRET:latest,DATABASE_URL=DATABASE_URL:latest,REDIS_URL=REDIS_URL:latest"

          # Check for optional secrets
          OPTIONAL_SECRETS=""
          for secret in OPENAI_API_KEY FACEBOOK_CLIENT_ID FACEBOOK_CLIENT_SECRET TAVILY_API_KEY; do
            if gcloud secrets describe $secret --project=${{ env.GCP_PROJECT_ID }} &>/dev/null; then
              OPTIONAL_SECRETS="${OPTIONAL_SECRETS},${secret}=${secret}:latest"
            fi
          done

          SECRETS_LIST="${REQUIRED_SECRETS}${OPTIONAL_SECRETS}"

          gcloud run deploy ${{ env.GCP_SERVICE_NAME }} \
            --image ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GCP_ARTIFACT_REPO }}/${{ env.GCP_SERVICE_NAME }}:latest \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 2Gi \
            --cpu 2 \
            --min-instances 0 \
            --max-instances 10 \
            --port 3000 \
            --set-env-vars NODE_ENV=production,NEXTAUTH_URL=https://archcelerate.com,NEXT_PUBLIC_ENABLE_AI_AGENTS=true,NEXT_PUBLIC_ENABLE_MULTIMODAL=false \
            --set-secrets "$SECRETS_LIST" \
            --add-cloudsql-instances ${{ env.GCP_PROJECT_ID }}:${{ env.GCP_REGION }}:archcelerate-db \
            --timeout 60s

      - name: Wait for Service to be Ready
        id: wait
        run: |
          echo "Waiting for service to be ready..."
          sleep 15

          # Check health endpoint
          MAX_RETRIES=10
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://archcelerate.com/api/health || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Service is ready (HTTP $HTTP_CODE)"
              break
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Waiting for service... ($RETRY_COUNT/$MAX_RETRIES) - HTTP $HTTP_CODE"
            sleep 10
          done

          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "âŒ Service failed to become ready"
            exit 1
          fi

      - name: Run Database Migrations
        id: migrate
        if: ${{ !inputs.skip_migrations }}
        run: |
          echo "Running database migrations..."

          # Get database credentials
          DB_PASSWORD=$(gcloud secrets versions access latest --secret=DB_PASSWORD --project=${{ env.GCP_PROJECT_ID }})
          DB_HOST=$(gcloud sql instances describe archcelerate-db --project=${{ env.GCP_PROJECT_ID }} --format="value(ipAddresses[0].ipAddress)")

          # Run migrations
          export DATABASE_URL="postgresql://postgres:${DB_PASSWORD}@${DB_HOST}:5432/archcelerate?schema=public"
          npx prisma migrate deploy

          if [ $? -eq 0 ]; then
            echo "âœ… Database migrations completed"
          else
            echo "âŒ Database migrations failed"
            exit 1
          fi

      - name: Seed Database
        id: seed
        if: ${{ !inputs.skip_seeding }}
        run: |
          echo "Seeding database with curriculum content..."

          # Get database credentials
          DB_PASSWORD=$(gcloud secrets versions access latest --secret=DB_PASSWORD --project=${{ env.GCP_PROJECT_ID }})
          DB_HOST=$(gcloud sql instances describe archcelerate-db --project=${{ env.GCP_PROJECT_ID }} --format="value(ipAddresses[0].ipAddress)")

          export DATABASE_URL="postgresql://postgres:${DB_PASSWORD}@${DB_HOST}:5432/archcelerate?schema=public"

          # Seed Week 1
          echo "Seeding Week 1..."
          npx tsx prisma/seed-week1.ts || echo "âš ï¸  Week 1 already seeded or error occurred"

          # Seed Week 2
          echo "Seeding Week 2..."
          npx tsx prisma/seed-week2.ts || echo "âš ï¸  Week 2 already seeded or error occurred"

          # Seed Week 5
          echo "Seeding Week 5..."
          npx tsx prisma/seed-week5.ts || echo "âš ï¸  Week 5 already seeded or error occurred"

          # Seed Week 6
          echo "Seeding Week 6..."
          npx tsx prisma/seed-week6.ts || echo "âš ï¸  Week 6 already seeded or error occurred"

          # Seed remaining weeks
          echo "Seeding remaining weeks..."
          npx tsx prisma/seed-all-weeks.ts || echo "âš ï¸  Remaining weeks already seeded or error occurred"

          echo "âœ… Database seeding completed"

      - name: Verify Deployment
        id: verify
        run: |
          echo "Verifying deployment..."

          # Test health endpoint
          HEALTH_RESPONSE=$(curl -s https://archcelerate.com/api/health)
          echo "Health check response: $HEALTH_RESPONSE"

          if echo "$HEALTH_RESPONSE" | grep -q '"status":"ok"'; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check failed"
            exit 1
          fi

          # Get latest revision
          REVISION=$(gcloud run services describe ${{ env.GCP_SERVICE_NAME }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }} \
            --format="value(status.latestReadyRevisionName)")

          echo "Latest revision: $REVISION"

      - name: Generate Deployment Report
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "                     ðŸŽ‰ DEPLOYMENT REPORT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "DEPLOYMENT INFORMATION"
          echo "  Workflow:         ${{ github.workflow }}"
          echo "  Run ID:           ${{ github.run_id }}"
          echo "  Triggered by:     ${{ github.event_name }}"
          echo "  Branch:           ${{ github.ref_name }}"
          echo "  Commit:           ${{ github.sha }}"
          echo "  Actor:            ${{ github.actor }}"
          echo "  Timestamp:        $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "CONFIGURATION"
          echo "  Project:          ${{ env.GCP_PROJECT_ID }}"
          echo "  Region:           ${{ env.GCP_REGION }}"
          echo "  Service:          ${{ env.GCP_SERVICE_NAME }}"
          echo "  Skip Build:       ${{ inputs.skip_build || false }}"
          echo "  Skip Migrations:  ${{ inputs.skip_migrations || false }}"
          echo "  Skip Seeding:     ${{ inputs.skip_seeding || false }}"
          echo ""
          echo "EXECUTION STATUS"
          echo "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "  â”‚ Step                                   â”‚ Status     â”‚"
          echo "  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "  â”‚ 1. Checkout Code                       â”‚ ${{ steps.checkout.outcome || 'N/A' }}     â”‚"
          echo "  â”‚ 2. Setup Node.js                       â”‚ ${{ steps.setup-node.outcome || 'N/A' }}     â”‚"
          echo "  â”‚ 3. Install Dependencies                â”‚ ${{ steps.install.outcome || 'N/A' }}     â”‚"
          echo "  â”‚ 4. Authenticate to GCP                 â”‚ ${{ steps.auth.outcome || 'N/A' }}     â”‚"
          echo "  â”‚ 5. Build Docker Image                  â”‚ ${{ steps.build.outcome || 'skipped' }}   â”‚"
          echo "  â”‚ 6. Deploy to Cloud Run                 â”‚ ${{ steps.deploy.outcome || 'skipped' }}   â”‚"
          echo "  â”‚ 7. Wait for Service Ready              â”‚ ${{ steps.wait.outcome || 'N/A' }}     â”‚"
          echo "  â”‚ 8. Run Database Migrations             â”‚ ${{ steps.migrate.outcome || 'skipped' }}   â”‚"
          echo "  â”‚ 9. Seed Database                       â”‚ ${{ steps.seed.outcome || 'skipped' }}   â”‚"
          echo "  â”‚ 10. Verify Deployment                  â”‚ ${{ steps.verify.outcome || 'N/A' }}     â”‚"
          echo "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          echo "DEPLOYED SERVICES"
          echo "  Production URL:   https://archcelerate.com"
          echo "  Service URL:      https://archcelerate-h5rlhvwxaa-uc.a.run.app"
          echo "  Cloud Run:        archcelerate"
          echo "  Cloud SQL:        archcelerate-db (PostgreSQL 15 + pgvector)"
          echo "  Redis:            archcelerate-redis (e2-micro)"
          echo ""
          echo "VERIFICATION"

          # Test health endpoint
          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://archcelerate.com/api/health || echo "failed")
          if [ "$HEALTH_STATUS" = "200" ]; then
            echo "  Health Check:     âœ… PASSED (HTTP 200)"
          else
            echo "  Health Check:     âŒ FAILED (HTTP $HEALTH_STATUS)"
          fi

          echo ""
          echo "RESOURCES"
          echo "  View Logs:        gcloud run services logs tail ${{ env.GCP_SERVICE_NAME }} --region ${{ env.GCP_REGION }} --project ${{ env.GCP_PROJECT_ID }}"
          echo "  View Metrics:     https://console.cloud.google.com/run/detail/${{ env.GCP_REGION }}/${{ env.GCP_SERVICE_NAME }}/metrics?project=${{ env.GCP_PROJECT_ID }}"
          echo "  Cloud Console:    https://console.cloud.google.com/run?project=${{ env.GCP_PROJECT_ID }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Save report as artifact
          cat > deployment-report.txt << 'EOFR'
          DEPLOYMENT REPORT
          Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

          DEPLOYMENT INFORMATION
            Workflow:         ${{ github.workflow }}
            Run ID:           ${{ github.run_id }}
            Triggered by:     ${{ github.event_name }}
            Branch:           ${{ github.ref_name }}
            Commit:           ${{ github.sha }}
            Actor:            ${{ github.actor }}

          CONFIGURATION
            Project:          ${{ env.GCP_PROJECT_ID }}
            Region:           ${{ env.GCP_REGION }}
            Service:          ${{ env.GCP_SERVICE_NAME }}
            Skip Build:       ${{ inputs.skip_build || false }}
            Skip Migrations:  ${{ inputs.skip_migrations || false }}
            Skip Seeding:     ${{ inputs.skip_seeding || false }}

          EXECUTION STATUS
            1. Checkout Code                       ${{ steps.checkout.outcome || 'N/A' }}
            2. Setup Node.js                       ${{ steps.setup-node.outcome || 'N/A' }}
            3. Install Dependencies                ${{ steps.install.outcome || 'N/A' }}
            4. Authenticate to GCP                 ${{ steps.auth.outcome || 'N/A' }}
            5. Build Docker Image                  ${{ steps.build.outcome || 'skipped' }}
            6. Deploy to Cloud Run                 ${{ steps.deploy.outcome || 'skipped' }}
            7. Wait for Service Ready              ${{ steps.wait.outcome || 'N/A' }}
            8. Run Database Migrations             ${{ steps.migrate.outcome || 'skipped' }}
            9. Seed Database                       ${{ steps.seed.outcome || 'skipped' }}
            10. Verify Deployment                  ${{ steps.verify.outcome || 'N/A' }}

          DEPLOYED SERVICES
            Production URL:   https://archcelerate.com
            Service URL:      https://archcelerate-h5rlhvwxaa-uc.a.run.app

          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          EOFR

      - name: Upload Deployment Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report-${{ github.run_id }}
          path: deployment-report.txt
          retention-days: 30
